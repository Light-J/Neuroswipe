<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="fragments/head(title='Ratings')" ></head>
<body class="overflow-hidden">

<nav class="navbar navbar-default" th:replace="fragments/navigation"></nav>

<div class="container">

    <div th:replace="fragments/information"></div>

<!--//Modal displayed after 25 answers, giving 1 reward-->
<div class="modal fade" id="rewardModal" tabindex="-1" role="dialog" aria-labelledby="rewardModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rewardModalLongTitle">Congratulations</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <h3 id="reward25_title">Temporal Lobe</h3>
                <p id="reward25_body">Great work! You just unlocked the temporal lobe. The temporal is involved in perceiving and remembering sounds. It also works in conjunction with the hippocampus to form conscious memories. The case of Henry Molaison 1926-2008: From an early age, Henry suffered from severe epilepsy. In an effort to control his seizures, he had an operation that removed a large part of his temporal lobe and hippocampus on both sides. Whilst the surgery cured him of his epilepsy, tragically he was left unable to form new memories.</p>
                <img id="reward25_image" src="/img/reward_images/cerebellum.jpg" height="300">


            </div>
        </div>
    </div>
</div>

<div class="container">

    <!--Modal displayed after 50 answers, giving 1 reward and a prompt for the user to move onto feedback-->
    <div class="modal fade" id="feedbackRewardModal" tabindex="-1" role="dialog" aria-labelledby="rewardModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reward25ModalLongTitle">Congratulations</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="container-fluid">

                        <div class="row">

                        <h3 id="reward_title">The parietal lobe</h3>
                        <p id="reward_body">Well done â€“ you just unlocked the parietal lobe! The parietal lobe contains an area of gray matter called the sensory strip. This processes sensory information such as pain, touch and temperature. The somatosensory homunculus: The sensory strip contains a map of our body. This is called the somatosensory homunculus and is shown below. When you touch something soft with your hand, this information will travel up to the sensory strip to where the hand is mapped on the homunculus. </p>
                        <img id="reward_image" src="/img/reward_images/cerebellum.jpg" height="300">

                        </div>

                        <div class="row">

                            <h3>50 ratings complete</h3>
                            <p>Thank you for the good work! Why don't you take a break and leave some feedback?</p>
                            <div class="container">
                                <form method="get" action="/userfeedback/">
                                    <div class="row">
                                        <button type="submit" class="btn btn-primary col-lg-6">Go to feedback</button>
                                        <button type="button" class="btn btn-danger col-lg-6 close" data-dismiss="modal" aria-label="Close">I'll Do It Later</button>
                                    </div>
                                </form>
                            </div>

                        </div>

                    </div>

                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>


    <div class="card">
        <div class="card-body">
            <p class="card-text text-center lead">Your progress to 50 images:</p>
            <div id="progress">
                <div id="bar">
                    <p class="text-center text-light" id="completedText" hidden="hidden">Completed!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="imagesCard">
        <div class="card-body">
            <h5 class="card-title text-center">Sort scans for real!</h5>
            <p class="card-text text-center lead">Is this a good scan of a brain?</p>
            <img class="image-order" src="" id="brainImage1" style="width:33%">
            <img class="image-order" src="" id="brainImage2" style="width:33%">
            <img class="image-order" src="" id="brainImage3" style="width:33%">
            <p class="text-center">
                <br><br>
                <button id="noButton" class="btn btn-danger btn-lg">No</button>&nbsp;&nbsp;&nbsp;&nbsp;
                <button id="yesButton" class="btn btn-success btn-lg">Yes</button>
            </p>
        </div>
    </div>

    <div class="float-right">
        <button type="button" onclick="window.location.href='/'" class="btn btn-outline-secondary" id="save">Save and Exit</button>
    </div>

</div>

<script>
    var loadNextImage = function(){
        $.getJSON("/scans/next", function( imageData ) {
            $("#brainImage1").attr("src", "/brain_images/"+imageData.topImage);
            $("#brainImage2").attr("src", "/brain_images/"+imageData.sideImage);
            $("#brainImage3").attr("src", "/brain_images/"+imageData.frontImage);
            $("#brainImage1").data("id", imageData.id);
            $("#yesButton, #noButton").fadeIn(250);
            $("#imagesCard").fadeOut(250, function () {
                $("#imagesCard").removeClass("swipe-right swipe-left");
                $("#imagesCard").fadeIn(250);
            });
        });

        var percentage = ($("#bar").width() / $('#bar').parent().width() * 100)+2;
        updateProgressBar(percentage);



        if(percentage > 49.5 && percentage < 50.5){
            $.ajax({
                type: "GET",
                url: "/api/rewards/get/sort25",
                success: function(data){
                    if(!data){
                        //Show 25 modal
                        $('#rewardModal').find("img").attr("src","/img/img20.png");
                        $('#rewardModal').modal('show');
                        $.ajax({
                            type: "POST",
                            url: "/api/rewards/set/sort25?value=1",
                            success: function(data){
                            },
                            error: function(){
                                alert("There was an error getting this data.");
                            }
                        });
                    }
                },
                error: function(){
                    alert("There was an error getting this data.");
                }
            });

        } else if(percentage > 99.5 && percentage < 100.5){
            $.ajax({
                type: "GET",
                url: "/api/rewards/get/sort50",
                success: function(data){
                    if(!data){
                        //show 50 modal
                        $('#feedbackRewardModal').find("img").attr("src","/img/img23.png");
                        $('#feedbackRewardModal').modal('show');
                        $.ajax({
                            type: "POST",
                            url: "/api/rewards/set/sort50?value=1",
                            success: function(data){
                            },
                            error: function(){
                                alert("There was an error getting this data.");
                            }
                        });
                    }
                },
                error: function(){
                    alert("There was an error getting this data.");
                }
            });

        }
    };

    var saveDecisionAndNextImage = function(goodBrain){
        //$("#yesButton, #noButton").hide();
        if(goodBrain){
            $("#imagesCard").addClass("swipe-right");
        }else{
            $("#imagesCard").addClass("swipe-left");
        }

        $.ajax({
            type: "POST",
            url: "/ratings/save",
            data: {
            	"scanId": $("#brainImage1").data("id"),
                "goodBrain": goodBrain
            },
            success: function(data){


                setTimeout(function(){
                    loadNextImage();
                }, 250);
            },
            error: function(){
                alert("There was an error submitting the data.");
            },
            dataType: "json"
        });
    };

    function getNumberOfUserResponses(){
        $.ajax({
            type: "GET",
            url: "/ratings/responses/amount",
            success: function(data){
                updateProgressBar(data*2);
            },
            error: function(){
                alert("There was an error getting this data.");
            }
        });

    }


    var updateProgressBar = function(percentage){
        if(percentage>100){
            percentage = 100;
            $("#completedText").removeAttr("hidden");
        }
        $("#bar").width(percentage+"%");
    };

    $(function() {
        getNumberOfUserResponses();
        $("#imagesCard").hide();
        loadNextImage();
        $("#yesButton").on("click", function(){
            saveDecisionAndNextImage(true);
        });

        $("#noButton").on("click", function(){
            saveDecisionAndNextImage(false);
        });

        $("#imagesCard").swipe( {
            swipe: function(event, direction){
                if(direction == "left"){
                    saveDecisionAndNextImage(false);
                } else if (direction == "right") {
                    saveDecisionAndNextImage(true);
                }
            }
        });

        $(document).keyup(function(e) {
            switch(e.which) {
                case 37: // left
                    if(!$("#noButton").prop("disabled")){
                        saveDecisionAndNextImage(false);
                    }
                    break;
                case 39: // right
                    if(!$("#yesButton").prop("disabled")) {
                        saveDecisionAndNextImage(true);
                    }
                    break;
                default: return; // exit this handler for other keys
            }
            e.preventDefault(); // prevent the default action (scroll / move caret)
        });
    });

</script>
<style>
    .card {
        margin: 10px;
    }

    #save {
        margin: 10px;
    }

    #progress {
        width: 100%;
        background-color: grey;
        margin-bottom: 10px;
    }

    #bar {
        width: 0%;
        height: 30px;
        background-color: green;
    }

    @media only screen and (max-width: 992px)  {
        .image-order{
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10px;
        }
    }

</style>

</body>
</html>