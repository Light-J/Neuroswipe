<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="fragments/head(title='Ratings')" ></head>
<body class="overflow-hidden">

<nav class="navbar navbar-default" th:replace="fragments/navigation"></nav>

<div class="container">
    <div hidden id="total-voted"></div>

    <div th:replace="fragments/information"></div>
    <div th:replace="fragments/dropdown"></div>

<!--//Modal displayed after 25 answers, giving 1 reward-->
<div class="modal fade" id="rewardModal" tabindex="-1" role="dialog" aria-labelledby="rewardModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rewardModalLongTitle">Congratulations</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h3 id="reward25_title">Temporal Lobe</h3>
                <p id="reward25_body">Great work! You just unlocked the temporal lobe. The temporal lobe is involved in perceiving and remembering sounds. It also works in with other areas of the brain to form conscious memories.</p>
                <div class="card" style="width: 100%">
                    <div class="card-body text-center">
                        <img id="reward25_image" src="/img/img24.jpg" height="300">
                        <h5 class="card-title" id="img_text" style="margin-top: 2rem">Temporal Lobe</h5>
                    </div>
                </div>
                <button id="reward25_btn" class="btn btn-primary btn-block" onclick="change25Modal()">Next</button>
            </div>
        </div>
    </div>
</div>


<div class="container">


    <div class="modal fade" id="rewardModal50" tabindex="-1" role="dialog" aria-labelledby="rewardModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rewardModalLongTitle50">Congratulations</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3 id="reward50_title">The parietal lobe</h3>
                    <p id="reward50_body">Well done â€“ you just unlocked the parietal lobe!  The parietal lobe contains an area of grey matter called the sensory strip. This processes sensory information such as pain, touch and temperature.</p>
                    <div class="card" style="width: 100%">
                        <img id="reward50_image" src="/img/img23.jpg" height="400">
                    </div>
                    <button id="reward50_btn" class="btn btn-primary btn-block" onclick="change50Modal()">Next</button>
                    <div class="row" id="goToFeedbackButtons" hidden>
                        <button type="button" class="btn btn-danger col-lg-6 close" data-dismiss="modal" aria-label="Close">I'll Do It Later</button>
                        <a href="/userfeedback/"><button type="button" class="btn btn-primary col-lg-6">Go to feedback</button></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card" style="margin-bottom: 5px">
        <div class="card-body">
            <p class="card-text text-center lead">Your progress to 50 images:</p>
            <div id="progress" class="row">
                <div id="bar">
                    <p class="text-center text-light" id="completedText" hidden="hidden">Completed!</p>
                </div>
                <div id="indicator">
                    <span id="ammount-completed">0/50</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="imagesCard">
        <div class="card-body">
            <p class="card-text text-center lead">Does this look like a fornix?</p>
            <img class="image-order" src="" id="brainImage1">
            <img class="image-order" src="" id="brainImage2">
            <img class="image-order" src="" id="brainImage3">
            <p class="text-center">
                <br><br>
                <button id="noButton" class="btn btn-danger btn-lg">No</button>&nbsp;&nbsp;&nbsp;&nbsp;
                <button id="yesButton" class="btn btn-success btn-lg">Yes</button>
            </p>
        </div>
    </div>

    <div class="float-right">
        <button type="button" onclick="window.location.href='/'" class="btn btn-outline-secondary" id="save">Save and Exit</button>
    </div>
</div>

</div>

<script>
    var loadNextImage = function(){
        $.getJSON("/api/scans/next", function( imageData ) {
            $("#brainImage1").attr("src", "/brain_images/"+imageData.topImage);
            $("#brainImage2").attr("src", "/brain_images/"+imageData.sideImage);
            $("#brainImage3").attr("src", "/brain_images/"+imageData.frontImage);
            $("#brainImage1").data("id", imageData.id);
            $("#yesButton, #noButton").fadeIn(250);
            $("#imagesCard").fadeOut(350, function () {
                $("#imagesCard").removeClass("swipe-right swipe-left");
                $("#imagesCard").fadeIn(250);
                $("#yesButton, #noButton").attr("disabled", false);
            });

        });

        var amount_of_voted = parseInt($("#total-voted").text());

        $("#total-voted").text(amount_of_voted+1);

        var percentage = (amount_of_voted/50)*100;
        updateProgressBar(percentage);

        if(amount_of_voted == 25){
            $.ajax({
                type: "GET",
                url: "/api/rewards/get/sort25",
                success: function(data){
                    if(!data){
                        //Show 25 modal
                        $('#rewardModal').find("img").attr("src","/img/img20.jpg");
                        $('#rewardModal').modal('show');
                        $.ajax({
                            type: "POST",
                            url: "/api/rewards/set/sort25?value=1",
                            success: function(data){
                            },
                            error: function(){
                                alert("There was an error getting this data.");
                            }
                        });
                    }
                },
                error: function(){
                    alert("There was an error getting this data.");
                }
            });

        } else if(amount_of_voted == 50){
            $.ajax({
                type: "GET",
                url: "/api/rewards/get/sort50",
                success: function(data){
                    if(!data){
                        //show 50 modal
                        $('#rewardModal50').modal('show');
                        $.ajax({
                            type: "POST",
                            url: "/api/rewards/set/sort50?value=1",
                            success: function(data){
                            },
                            error: function(){
                                alert("There was an error getting this data.");
                            }
                        });
                    }
                },
                error: function(){
                    alert("There was an error getting this data.");
                }
            });

        }
    };

    var saveDecisionAndNextImage = function(goodBrain){
        if(goodBrain){
            $("#imagesCard").addClass("swipe-right");
        }else{
            $("#imagesCard").addClass("swipe-left");
        }

        $.ajax({
            type: "POST",
            url: "/api/ratings/save",
            data: {
            	"scanId": $("#brainImage1").data("id"),
                "goodBrain": goodBrain
            },
            success: function(data){


                setTimeout(function(){
                    loadNextImage();
                }, 250);
            },
            error: function(){
                alert("There was an error submitting the data.");
            },
            dataType: "json"
        });
    };

    function getNumberOfUserResponses(){
        $.ajax({
            type: "GET",
            url: "/api/ratings/responses/amount",
            success: function(data){
                $("#total-voted").text(data);
                updateProgressBar(data*2);
            },
            error: function(){
                alert("There was an error getting this data.");
            }
        });

    }


    var updateProgressBar = function(percentage){
        if(percentage>=100){
            percentage = 100;
            $("#ammount-completed").attr("hidden", "true");
            $("#completedText").removeAttr("hidden");
        }
        $("#ammount-completed").text((percentage/2).toFixed() + "/50");
        $("#bar").css("width", "calc("+percentage+"% - "+$("#ammount-completed").width()+"px)")
    };

    $(function() {
        displayNotification("Welcome", "You are now rating live images. You are helping us determine whether these fornix pictures are adequate or not")
        getNumberOfUserResponses();
        $("#imagesCard").hide();
        loadNextImage();
        $("#yesButton").on("click", function(){
            saveDecisionAndNextImage(true);
        });

        $("#noButton").on("click", function(){
            saveDecisionAndNextImage(false);
        });

        $("#imagesCard").swipe( {
            swipe: function(event, direction){
                if(direction == "left"){
                    saveDecisionAndNextImage(false);
                } else if (direction == "right") {
                    saveDecisionAndNextImage(true);
                }
            },
            allowPageScroll:"auto"});

        $(document).keyup(function(e) {
            switch(e.which) {
                case 37: // left
                    if(!$("#noButton").prop("disabled")){
                        $("#yesButton, #noButton").attr("disabled", true);
                        saveDecisionAndNextImage(false);
                    }
                    break;
                case 39: // right
                    if(!$("#yesButton").prop("disabled")) {
                        $("#yesButton, #noButton").attr("disabled", true);
                        saveDecisionAndNextImage(true);
                    }
                    break;
                default: return; // exit this handler for other keys
            }
            e.preventDefault(); // prevent the default action (scroll / move caret)
        });
    });

    function change25Modal() {
        document.getElementById("rewardModalLongTitle").innerHTML = "Case Study";
        document.getElementById("reward25_title").innerHTML = "The case of Henry Molaison 1926-2008:";
        document.getElementById("reward25_body").innerHTML = "From an early age, Molaison suffered from severe epilepsy. In an effort to control his seizures, he underwent a major operation that removed a large part of his temporal lobe and hippocampus. Whilst the surgery cured Molaison of his epilepsy he was tragically left unable to form new memories.";
        document.getElementById("reward25_image").src = "/img/reward_case_2.jpg";
        document.getElementById("img_text").innerHTML = "Henry Molaison";
        document.getElementById("reward25_btn").style.display = "none";
    }

    function change50Modal() {
        document.getElementById("reward50_body").innerHTML = "The sensory strip is like a map of our body â€“ the bumps and grooves on the brainâ€™s surface receive information from different parts of the body. It is called the somatosensory homunculus (shown below). The bigger the body part is on the homunculus, the more sensitive the body part. You can see the hands are huge! ";
        document.getElementById("reward50_image").src = "/img/reward_case_3.jpg";
        document.getElementById("reward50_btn").style.display = "none";
        $("#goToFeedbackButtons").removeAttr('hidden');
    }


</script>
<style>
    #save {
        margin: 10px;
    }

    #progress {
        width: 100%;
        background-color: grey;
        margin-bottom: 10px;
    }

    #bar {
        width: 0%;
        height: 30px;
        background-color: green;
        text-align: center;
        line-height: 30px;
        color: white;
    }

    #indicator {
        height: 30px;
        background-color: lightgray;

    }
</style>

</body>
</html>